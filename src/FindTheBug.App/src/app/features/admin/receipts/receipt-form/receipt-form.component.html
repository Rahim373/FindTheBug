<nz-card [nzTitle]="isViewMode ? 'View Receipt' : (isEditMode ? 'Edit Receipt' : 'New Receipt')" [nzLoading]="loading">
  <form nz-form [formGroup]="receiptForm" (ngSubmit)="onSubmit()">
    
    <nz-row [nzGutter]="16">
      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Invoice Number</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Invoice number is required">
            <input nz-input formControlName="invoiceNumber" [attr.disabled]="isViewMode" placeholder="INV-XXXXX" />
          </nz-form-control>
        </nz-form-item>
      </nz-col>

      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Phone Number</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Phone number is required">
            <input nz-input formControlName="phoneNumber" [attr.disabled]="isViewMode" placeholder="Enter phone number" />
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>

    <nz-row [nzGutter]="16">
      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Full Name</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Full name is required">
            <input nz-input formControlName="fullName" [attr.disabled]="isViewMode" placeholder="Enter patient name" />
          </nz-form-control>
        </nz-form-item>
      </nz-col>

      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6">Referring Doctor</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select formControlName="referredByDoctorId" [attr.disabled]="isViewMode" nzAllowClear nzShowSearch nzPlaceHolder="Select doctor">
              @for (doctor of availableDoctors(); track doctor.id) {
                <nz-option [nzValue]="doctor.id" [nzLabel]="doctor.name"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>

    <nz-row [nzGutter]="16">
      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6">Age</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Age must be between 0 and 120">
            <nz-input-wrapper>
              <input type="number" nz-input formControlName="age" [attr.disabled]="isViewMode" placeholder="Age" />
              <nz-select nzInputAddonAfter  formControlName="isAgeYear" [attr.disabled]="isViewMode">
                <nz-option nzValue="true" nzLabel="  Year  "></nz-option>
                <nz-option nzValue="false" nzLabel="  Month  "></nz-option>
              </nz-select>
            </nz-input-wrapper>
          </nz-form-control>
        </nz-form-item>
      </nz-col>

      <nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Gender</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select formControlName="gender" [attr.disabled]="isViewMode">
              <nz-option nzValue="Male" nzLabel="Male"></nz-option>
              <nz-option nzValue="Female" nzLabel="Female"></nz-option>
              <nz-option nzValue="Other" nzLabel="Other"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>

    <nz-form-item>
      <nz-form-label [nzSpan]="3">Address</nz-form-label>
      <nz-form-control [nzSpan]="21" nzErrorTip="Address must not exceed 500 characters">
        <textarea nz-input formControlName="address" [attr.disabled]="isViewMode" placeholder="Enter address (optional)" [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea>
      </nz-form-control>
    </nz-form-item>

    @if (canEdit()) {
      <nz-row [nzGutter]="16">
        <nz-col [nzSpan]="16">
          <nz-form-item>
            <nz-form-label [nzSpan]="6">Select Test</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <nz-select formControlName="selectedTest" [nzLoading]="loadingTests()" nzAllowClear nzShowSearch nzPlaceHolder="Select a test">
                @for (test of availableTests(); track test.id) {
                  <nz-option [nzValue]="test.id" [nzLabel]="test.testName + ' - ' + test.category"></nz-option>
                }
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-control [nzSpan]="18" [nzOffset]="6">
              <button nz-button nzType="primary" (click)="addTestEntry()">
                <span nz-icon nzType="plus"></span>
                Add Test
              </button>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    }

    <nz-table #testTable [nzData]="testEntries()" [nzShowPagination]="false">
      <thead>
        <tr>
          <th>Test Name</th>
          <th>Rate</th>
          @if (canEdit()) {
            <th>Discount</th>
          }
          <th>Total</th>
          @if (canEdit()) {
            <th>Actions</th>
          }
        </tr>
      </thead>
      <tbody>
        @for (entry of testTable.data; track entry.diagnosticTestId; let i = $index) {
          <tr>
            <td>{{ entry.diagnosticTestName }}</td>
            <td>{{ entry.rate.toFixed(2) }}</td>
            @if (canEdit()) {
              <td>
                <input type="number" nz-input [(ngModel)]="entry.discount" (ngModelChange)="updateTestEntry(i, 'discount', +$event)" min="0" [max]="entry.rate" style="width: 80px;" />
              </td>
            }
            <td>{{ entry.total.toFixed(2) }}</td>
            @if (canEdit()) {
              <td>
                <button nz-button nzType="link" nzDanger (click)="removeTestEntry(i)">
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            }
          </tr>
        }
      </tbody>
    </nz-table>

    <nz-row [nzJustify]="'end'" [nzAlign]="'middle'">
      <nz-col [nzSpan]="8">
        <div class="summary">
          <div class="summary-row">
            <span>Sub Total:</span>
            <span class="amount">{{ subTotal() | number:'.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span>Discount:</span>
            @if (canEdit()) {
              <input type="number" nz-input formControlName="discount" min="0" style="width: 120px; text-align: right;" />
            } @else {
              <span class="amount">{{ receiptForm.get('discount')?.value | number:'.2-2' }}</span>
            }
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span class="amount">{{ total() | number:'.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span>Paid (Balance):</span>
            @if (canEdit()) {
              <input type="number" nz-input formControlName="balance" min="0" style="width: 120px; text-align: right;" />
            } @else {
              <span class="amount">{{ receiptForm.get('balance')?.value | number:'.2-2' }}</span>
            }
          </div>
          <div class="summary-row due">
            <span>Due:</span>
            <span class="amount">{{ due() | number:'.2-2' }}</span>
          </div>
        </div>
      </nz-col>
    </nz-row>

    @if (canEdit()) {
      <nz-divider></nz-divider>

      <nz-row [nzJustify]="'end'">
        <nz-col>
          <div class="form-actions">
            <button nz-button nzType="default" (click)="cancel()">Cancel</button>
            <button nz-button nzType="primary" [nzLoading]="submitting" type="submit">
              {{ isEditMode ? 'Update Receipt' : 'Create Receipt' }}
            </button>
          </div>
        </nz-col>
      </nz-row>
    }
  </form>
</nz-card>